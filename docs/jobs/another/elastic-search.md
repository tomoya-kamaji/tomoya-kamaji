---
layout: default
title: ユーザ検索機能の全文検索エンジン実装とパフォーマンス・チューニング
---

[← プロフィールに戻る](../../index.md)

### 背景

企業側のメイン機能であるユーザ検索機能のリプレイスに伴い全文検索エンジンの実装、パフォーマンス・チューニングを行った。

#### 全文検索の課題

- RDB、Like 句の部分一致での検索ノイズが多かったのでこちらを改修したかった

#### パフォーマンスの課題

- 悪化していた原因として、検索条件複雑化に伴いテーブルの join が肥大化していた。またそれに伴いコードが複雑になり改修がしづらくなっていた。

### 発揮したバリュー

上記課題を解決するため、検索部分に ElasticSearch を使用する方針を決定して、setting,mapping の作成から検索機能の実装まで一通り行った。

#### 具体的な実装

- ElasticSearch の analyzer、index の定義(analyzer は Ngram と Kuromoji を使用)
- MySQL から ElasticSearch のドキュメントへのデータの流し込み(バッチ処理の実装)
- 検索 API 実装：検索クエリの作成

#### 意識した点、苦労した点

「検索ノイズが少なく、検索漏れも少ない全文検索エンジン」の構築に苦労しましたが、最終的に Ngram と kuromoji を併用する方法で実装を行いました。
Ngram はノイズが多いが、検索漏れが少ないのでこちらを必須の検索条件(query の must 句)に定義する。
Kuromoji は検索漏れは多いが、ノイズが少ないのでこちらを任意の検索条件(query の should 句)に定義する。
両者を検索条件に含めることで、検索ワードの類似度が高い(\_score が高い)ものが上位に表示されるようになりました。

#### 結果

その結果 2.0s かかっていた検索処理を 0.5s まで改善することができた。また、検索時の実装がシンプルになりコードの可読性も高くなった。この経験を通して、ElasticSearch やパフォーマンス・チューニングについての知見を得ることができた。

---

[← プロフィールに戻る](../../index.md)
